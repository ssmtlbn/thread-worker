/*!
ThreadWorker v0.0.2 
(c) 2015 Samuel Samtleben 
License: MIT 
*/

!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof exports?module.exports=b():a.threadWorker=b()}(this,function(){function a(){this._listener={}}function b(b){if(this._name=null,this._dependencies=null,this._function=null,this._arguments=null,this._eventManager=new a,this.promise=void 0,this._resolve=void 0,this._reject=void 0,arguments.length<1)throw new Error("Too few arguments.");if(arguments.length>4)throw new Error("Too many arguments.");var c=Array.prototype.slice.call(arguments);if(c.length>1&&"string"==typeof c[0]&&(this._name=c.shift()),c.length>1&&c[0]instanceof Array&&(this._dependencies=c.shift()),!(c.length>0&&c[0]instanceof Function))throw new Error("Function is missing");this._function=c.shift(),c.length>0&&(this._arguments=c.shift()),this.promise=new Promise(function(a,b){this._resolve=a,this._reject=b}.bind(this))}function c(){this._size=0,this._threads=[],this._threadsState={},this._queue=[],this._state=c.State.NEW,this._threadConfig=null,Object.keys(d.State).forEach(function(a,b,c){this._threadsState[d.State[a]]=[]},this)}function d(){this._id=j++,this._state=d.State.NEW,this._job=null,this._cache={},this._worker,this._eventManager=new a,this._config}function e(a){setTimeout(a,0)}function f(){return-1!==navigator.userAgent.indexOf("MSIE ")||-1!==navigator.userAgent.indexOf("Trident/")}var g={};a.prototype.addEventListener=function(a,b){this._listener[a]||(this._listener[a]=[]),this._listener[a].push(b)},a.prototype.removeEventListener=function(a,b){if(this._listener[a])if(b)for(var c=this._listener[a].length;c--;)this._listener[a][c]===b&&this._listener[a].splice(c,1);else this._listener[a]=[]},a.prototype.callEventListener=function(a,b,c){void 0===c&&(c=!0),this._listener[a]&&this._listener[a].forEach(function(a){c?setTimeout(function(){a.apply(null,b)},0):a.apply(null,b)})},g.EventManager=a,b.EventType={START:0,PROCESS:1,SUCCESS:2,ERROR:3,DONE:4,CANCELED:5,FINALLY:6},Object.freeze&&Object.freeze(b.EventType),b.prototype.getName=function(){return this._name},b.prototype.getDependencies=function(){return this._dependencies},b.prototype.getFunction=function(){return this._function},b.prototype.getArguments=function(){return this._arguments},b.prototype.triggerEvent=function(a,c){this._eventManager.callEventListener(a,[c]),a===b.EventType.SUCCESS?this._resolve&&this._resolve(c):(a===b.EventType.ERROR||a===b.EventType.CANCELED)&&this._reject&&this._reject(c)},b.prototype.start=function(a){return this._eventManager.addEventListener(b.EventType.START,a),this},b.prototype.process=function(a){return this._eventManager.addEventListener(b.EventType.PROCESS,a),this},b.prototype.success=function(a){return this._eventManager.addEventListener(b.EventType.SUCCESS,a),this},b.prototype.error=function(a){return this._eventManager.addEventListener(b.EventType.ERROR,a),this},b.prototype.done=function(a){return this._eventManager.addEventListener(b.EventType.DONE,a),this},b.prototype.canceled=function(a){return this._eventManager.addEventListener(b.EventType.CANCELED,a),this},b.prototype["finally"]=function(a){return this._eventManager.addEventListener(b.EventType.FINALLY,a),this},g.ThreadJob=b,c.State={NEW:0,RUNNING:1,PAUSED:2},Object.freeze&&Object.freeze(c.State),c.prototype.config=function(a){if(this._state!==c.State.NEW)throw new Error("Thread pool can only be configured in state 'NEW'");if(a.size){if(isNaN(a.size))throw new Error("'size' is not a number");this._size=a.size}return a.thread&&(this._threadConfig=a.thread),this},c.prototype.run=function(a){if(0===this._size)throw new Error("Pool size is 0. Use configure() to set a size greater then 0.");Array.prototype.unshift.call(arguments,null);var d=new(Function.prototype.bind.apply(b,arguments));return this._state=c.State.RUNNING,this._queue.push(d),e(this._manageThreads.bind(this)),d},c.prototype._manageThreads=function(){if(this._state===c.State.RUNNING&&this._queue.length>0){var a;this._threadsState[d.State.FREE].length>0?a=this._threadsState[d.State.FREE].pop():this._threadsState[d.State.NEW].length>0?a=this._threadsState[d.State.NEW].pop():this._threads.length<this._size&&(a=new d,this._threads.push(a),this._threadConfig&&a.config(this._threadConfig),a.addEventListener("statechange",function(a){var b=this._threadsState[a.stateFrom].indexOf(a.target);b>-1&&this._threadsState[a.stateFrom].splice(b,1),a.stateTo!==d.State.TERMINATED?this._threadsState[a.stateTo].push(a.target):(b=this._threads.indexOf(a.target),b>-1&&this._threads.splice(b,1)),e(this._manageThreads.bind(this))}.bind(this))),a&&a.run(this._queue.shift())}},c.prototype.cancelJob=function(a){if(!a)throw new Error("Name not specified");for(var c=this._queue.length;c--;)if(this._queue[c].getName()===a){var d=this._queue.splice(c,1)[0];d.triggerEvent(b.EventType.CANCELED,"The job was canceled"),d.triggerEvent(b.EventType.FINALLY)}for(c=this._threads.length;c--;){var d=this._threads[c].getJob();d&&d.getName()===a&&this._threads[c].terminate()}},c.prototype.cancelAllJobs=function(){for(var a=this._queue.slice(0,this._queue.length),c=0;c<a.length;c++)a[c].triggerEvent(b.EventType.CANCELED,"The job was canceled"),a[c].triggerEvent(b.EventType.FINALLY);for(var c=0;c<this._threads.length;c++)this._threads[c].terminate()},c.prototype.terminate=function(a){for(var b=!1,c=this._threads.length;!b&&c--;)this._threads[c].getId()===a&&(this._threads[c].terminate(),b=!0)},c.prototype.terminateAll=function(){for(var a=0;a<this._threads.length;a++)this._threads[a].terminate()},c.prototype.clearQueue=function(){this._queue=[]},c.prototype.getQueueSize=function(){return this._jobQueue.length},c.prototype.isThreadAvailable=function(){return 0===this._queue.length&&this._threads.length<this._size},c.prototype.pause=function(){this._state=c.State.PAUSED},c.prototype.resume=function(){this._state===c.State.PAUSED&&(this._state=c.State.RUNNING,e(this._manageThreads.bind(this)))},g.ThreadPool=c;var h=function(){function a(a){var d=a.data;switch(d.cmd){case"SET_UP":b(d.setup);break;case"RUN":c(d.args);break;case"RESET":f();break;default:throw new Error("Unknown command: "+d.cmd)}}function b(a){if(k=Function.apply(null,a.fn.params.concat(a.fn.body)),l=a.execLocation,a.requirejs){var b=a.requirejs;importScripts(h(b.url));var c=b.config||{};c.baseUrl?c.baseUrl=h(c.baseUrl):c.baseUrl=h("./"),b.config&&require.config(b.config);var d=[];b.dataMain&&(d=[b.dataMain]),require(d,function(){a.dependencies?require(a.dependencies,function(){m=Array.prototype.slice.call(arguments),g({cmd:"SET_UP"})}):g({cmd:"SET_UP"})})}else a.dependencies&&a.dependencies.forEach(function(a){importScripts(h(a))}),g({cmd:"SET_UP"})}function c(a){try{k.apply(null,[d,e].concat(m,a))}catch(b){e(b)}}function d(a){g({cmd:"RESOLVE",result:a})}function e(a){if(a instanceof Error){var b={type:"error",message:a.toString(),fileName:a.fileName,lineNumber:a.lineNumber,columnNumber:a.columnNumber};a=b}g({cmd:"REJECT",reason:a})}function f(){k=null,g({cmd:"RESET"})}function g(a){i.postMessage(a)}function h(a){if(j.test(a))return a;var b=l.pathname.split("/"),c=a.split("/");b.pop(),b.length>0&&""===b[0]&&b.shift();for(var d=0;d<c.length;d++)"."!==c[d]&&(".."===c[d]?b.pop():b.push(c[d]));return l.protocol+"//"+l.hostname+":"+l.port+"/"+b.join("/")}var i=self,j=new RegExp("^(?:[a-z]+:)?//","i"),k=null,l=null,m=[];i.addEventListener("message",a),g({cmd:"INIT"})}.toString(),i=URL.createObjectURL(new Blob(["(",h,")()"],{type:"application/javascript"})),j=1e3;return d.State={NEW:1,FREE:2,SET_UP:3,RUNNING:4,TERMINATED:5},Object.freeze&&Object.freeze(d.State),d.prototype.addEventListener=function(a,b){this._eventManager.addEventListener(a,b)},d.prototype.removeEventListener=function(a,b){this._eventManager.removeEventListener(a,b)},d.prototype._onMessage=function(a){var c=a.data;switch(c.cmd){case"INIT":this._postSetup();break;case"SET_UP":this._postRun();break;case"RESET":this._postSetup();break;case"RESOLVE":this._job._resolve(c.result),this._job.triggerEvent(b.EventType.SUCCESS,c.result),this._job.triggerEvent(b.EventType.DONE,c.result),this._job.triggerEvent(b.EventType.ALWAYS,c.result),this._breakDown();break;case"REJECT":var d=c.reason;d.type&&"error"===d.type&&(d=new ErrorEvent("error",{message:d.message,filename:d.fileName,lineno:d.lineNumber,colno:d.columnNumber,error:null})),this._job.triggerEvent(b.EventType.ERROR,d),this._job.triggerEvent(b.EventType.DONE,d),this._job.triggerEvent(b.EventType.ALWAYS,d),this._breakDown();break;default:throw new Error("Unknown command: "+c.cmd)}},d.prototype._onError=function(a){this._job.triggerEvent(b.EventType.ERROR,a),this._job.triggerEvent(b.EventType.DONE,a),this._job.triggerEvent(b.EventType.ALWAYS,a),this._breakDown()},d.prototype._postMessage=function(a){this._worker&&this._worker.postMessage(a)},d.prototype._changeState=function(a){var b=this._state;this._state=a;var c={type:"ThreadEvent",target:this,stateFrom:b,stateTo:a};this._eventManager.callEventListener("statechange",[c])},d.prototype.config=function(a){if(this._state!==d.State.NEW)throw new Error("Thread can only be configured in state 'NEW'");return this._config=a,this},d.prototype.run=function(){if(this._state!==d.State.NEW&&this._state!==d.State.FREE)throw new Error("Thread is not in state 'NEW' oder 'FREE'");this._changeState(d.State.SET_UP);try{1===arguments.length&&arguments[0]instanceof b?this._job=arguments[0]:(Array.prototype.unshift.call(arguments,null),this._job=new(Function.prototype.bind.apply(b,arguments))),e(this._runJob.bind(this))}catch(a){throw this._breakDown(),a}return this._job},d.prototype._runJob=function(){if(this._worker)this._cache.fn===this._job.getFunction()?this._postRun():(this._cache={},this._postReset());else{if(this._cache={},f()){if(!this._config||!this._config.evalWorkerUrl)throw new Error("URL for eval-worker script not set");this._worker=new Worker(this._config.evalWorkerUrl),this._worker.postMessage(h)}else this._worker=new Worker(i);this._worker.addEventListener("message",this._onMessage.bind(this),!1),this._worker.addEventListener("error",this._onError.bind(this),!1)}},d.prototype._postSetup=function(){if(this._state!==d.State.SET_UP)throw new Error("Thread is not in state 'SET_UP'");var a={protocol:location.protocol,hostname:location.hostname,port:location.port,pathname:location.pathname},b=this._job.getFunction().toString(),c={params:b.substring(b.indexOf("(")+1,b.indexOf(")")).split(","),body:b.substring(b.indexOf("{")+1,b.lastIndexOf("}"))},e={cmd:"SET_UP",setup:{fn:c,execLocation:a}};this._config.requirejs&&(e.setup.requirejs=this._config.requirejs);var f=this._job.getDependencies();f&&(e.setup.dependencies=f),this._postMessage(e)},d.prototype._postRun=function(){this._changeState(d.State.RUNNING),this._job.triggerEvent(b.EventType.START);var a={cmd:"RUN"},c=this._job.getArguments();c&&(a.args=c),this._postMessage(a)},d.prototype._postReset=function(){this._postMessage({cmd:"RESET"})},d.prototype._breakDown=function(){this._job&&this._state>d.State.SET_UP&&(this._cache.fn=this._job.getFunction()),this._job=null,this._changeState(d.State.FREE)},d.prototype.terminate=function(){return new Promise(function(a,c){this._worker&&(this._worker.terminate(),this._worker=void 0),this._job&&(this._job.triggerEvent(b.EventType.CANCELED,"The thread was terminated"),this._job.triggerEvent(b.EventType.FINALLY)),this._changeState(d.State.TERMINATED),this._job=null,this._cache={},a(void 0)}.bind(this))},d.prototype.getState=function(){return this._state},d.prototype.getId=function(){return this._id},d.prototype.getJob=function(){return this._job},g.Thread=d,g.runDeferred=e,g.isIE=f,g});
//# sourceMappingURL=thread-worker.min.js.map